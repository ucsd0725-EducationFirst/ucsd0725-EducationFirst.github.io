<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="assets/css/style.css">
		<title>Charts</title>
	</head>
	<body>
		<div class="container">
		</div>

	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
	<script src="assets/js/jquery.flot.min.js" charset="utf-8"></script>
	<script src="assets/js/jquery.flot.categories.min.js" charset="utf-8"></script>
	<script src="assets/js/scorecard_api.js" charset="utf-8"></script>
	<script src="assets/js/test_data.js" charset="utf-8"></script>
	<script type="text/javascript">
		var data = TestData;
		var filtered = FilterChildrenByPropertyPath(data, ["programs", "bachelors"], function(x) { return x > 0.5; });
		var ordered = OrderChildrenByPropertyPath(filtered, ["school", "salary", "eventual", "50"]);

		function CalculateAverages(schools) {
			var averages = {
				"in-state-tuition": {count: 0, sum: 0},
				"out-state-tuition": {count: 0, sum: 0}
			};
			for (var i = 0; i < ordered.length; i++) {
				var s = ordered[i];
				if (s.school.tuition.in_state > 0) {
					averages["in-state-tuition"].count++;
					averages["in-state-tuition"].sum += s.school.tuition.in_state;
				}
				if (s.school.tuition.out_state > 0) {
					averages["out-state-tuition"].count++;
					averages["out-state-tuition"].sum += s.school.tuition.out_state;
				}
			}
			for (var key in averages) {
				var obj = averages[key];
				if (obj.count > 0) {
					obj.average = obj.sum / obj.count;
				} else {
					obj.average = 0;
				}
				averages[key] = obj;
			}
			return averages;
		}
		var averages = CalculateAverages(ordered);

		function CardForSchool(school, averages) {
			console.log(school);
			console.log(averages);
			var card = $("<div class='card uni-card'>").attr({id: "school-" + school.key}).data({state: "closed"});
			card.addClass("card-open") // debug
			var cardContent = $("<div class='card-content'>").appendTo(card);

			var minimize = $("<i>");
			minimize.addClass("material-icons right minimize-card");
			minimize.html('remove');
			minimize.data({schoolID: school.key});
			minimize.hide();

			var schoolName = $("<span class='school-name card-title'>").text(school.school.name);
			var loc = school.school.location.city + ", " + school.school.location.state;
			var schoolLoc = $("<span class='school-location'>").text(loc);

			var schoolInfo = $("<div class='school-info'>");
			schoolInfo.append($("<br>")).append($("<div class='divider'>")).append("<br>");
			if (school.school.url) {
				$("<p>").append($("<a>").attr({href: "http://" + school.school.url, target: "_blank"}).text("School Website")).appendTo(schoolInfo)
			}
			$("<h5>").text("Tuition").appendTo(schoolInfo);
			if (school.school.tuition.in_state > 0) {
				var chartID = "tuition-" + school.key;
				$("<div class='card-chart'>").attr({id: chartID}).appendTo(schoolInfo);
				setTimeout(function(chartID, tuition) {
					var thisSchool = [["In State", tuition.in_state], ["Out of State", tuition.out_state]];
					$.plot("#" + chartID, [thisSchool, averages], {
						series: {
							color: "green",
							bars: {show: true, align: "center"}
						},
						xaxis: {mode: "categories", tickLength: 0}
					});
				}, 100, chartID, school.school.tuition);
			} else {
				$("<p>").text("Tuition Data Unavailable").appendTo(schoolInfo);
			}

			[
				minimize,
				schoolName,
				schoolLoc,
				schoolInfo
			].forEach(function(element) {
				cardContent.append(element);
			});

			return card;
		}

		$(".container").append(CardForSchool(ordered[0], averages));



		// var d1 = [];
		// var d2 = [];
		// for (var i = 0; i < 14; i ++) {
		// 	d1.push([i, Math.sin(i)]);
		// 	d1.push([i+0.5, Math.sin(i+0.5)]);
		// 	d2.push([i, Math.sin(i)]);
		// }
		//
		// $.plot("#plot", [{
		// 	data: d1,
		// 	lines: { show: true, fill: false },
		// }, {
		// 	data: d2,
		// 	bars: { show: true, width: 0.5 }
		// }])
	</script>
	</body>
</html>
