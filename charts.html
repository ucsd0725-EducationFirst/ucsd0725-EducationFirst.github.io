<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="assets/css/style.css">
		<title>Charts</title>
	</head>
	<body>
		<div class="container">
		</div>

	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
	<script src="assets/js/jquery.flot.min.js" charset="utf-8"></script>
	<script src="assets/js/jquery.flot.categories.min.js" charset="utf-8"></script>
	<script src="assets/js/scorecard_api.js" charset="utf-8"></script>
	<script src="assets/js/test_data.js" charset="utf-8"></script>
	<script src="assets/js/view_controller.js" charset="utf-8"></script>
	<script type="text/javascript">
		var data = TestData;
		var filtered = FilterChildrenByPropertyPath(data, ["programs", "bachelors"], function(x) { return x > 0.5; });
		var ordered = OrderChildrenByPropertyPath(filtered, ["school", "salary", "eventual", "50"]);

		function CalculateAverages(schools) {
			var averages = {
				"in-state-tuition": {count: 0, sum: 0},
				"out-state-tuition": {count: 0, sum: 0}
			};
			for (var i = 0; i < ordered.length; i++) {
				var s = ordered[i];
				if (s.school.tuition.in_state > 0) {
					averages["in-state-tuition"].count++;
					averages["in-state-tuition"].sum += s.school.tuition.in_state;
				}
				if (s.school.tuition.out_state > 0) {
					averages["out-state-tuition"].count++;
					averages["out-state-tuition"].sum += s.school.tuition.out_state;
				}
			}
			for (var key in averages) {
				var obj = averages[key];
				if (obj.count > 0) {
					obj.average = obj.sum / obj.count;
				} else {
					obj.average = 0;
				}
				averages[key] = obj;
			}
			return averages;
		}
		var averages = CalculateAverages(ordered);

		function CardForSchool(school, averages) {
			console.log(school);
			var card = $("<div class='card uni-card'>").attr({id: "school-" + school.key}).data({state: "closed"});
			card.addClass("card-open") // debug
			var cardContent = $("<div class='card-content'>").appendTo(card);

			var minimize = $("<i>");
			minimize.addClass("material-icons right minimize-card");
			minimize.html('remove');
			minimize.data({schoolID: school.key});
			minimize.hide();

			var schoolName = $("<span class='school-name card-title'>").text(school.school.name);
			var loc = school.school.location.city + ", " + school.school.location.state;
			var schoolLoc = $("<span class='school-location'>").text(loc);

			var schoolInfo = $("<div class='school-info'>");
			schoolInfo.append($("<br>")).append($("<div class='divider'>")).append("<br>");

			var statsRow = $("<div class='row'>").appendTo(schoolInfo);
			var statsCol = $("<div class='col s6'>").appendTo(statsRow);
			var imgCol = $("<div class='col s6'>").appendTo(statsRow);
			$("<h5>").text("Statistics").appendTo(statsCol);
			if (school.school.url) {
				$("<p>").append($("<a>").attr({href: "http://" + school.school.url, target: "_blank"}).text("School Website")).appendTo(statsCol)
			}
			if (school.school.demographics.size > 0) {
				$("<p>").text("Student Population: " + school.school.demographics.size).appendTo(statsCol);
			}
			if (school.school.demographics.female > 0 || school.school.demographics.male > 0) {
				var fPerc = Math.floor(school.school.demographics.female * 100);
				var mPerc = 100 - fPerc;
				$("<p>").text(fPerc + "% Female | " + mPerc + "% Male").appendTo(statsCol);
			}
			var withPluses = school.school.name.split(" ").join("+");
			$.get("http://api.duckduckgo.com/?q=" + withPluses + "&format=json").done(function(json) {
				if (JSON.parse(json).Image) {
					$("<img class='school-logo'>").attr({src: JSON.parse(json).Image}).appendTo(imgCol);
				}
			});

			$("<h5>").text("Admissions").appendTo(schoolInfo);
			$("<p>").text("TODO: Add test scores").appendTo(schoolInfo);

			var moneyRow = $("<div class='row'>").appendTo(schoolInfo);
			var tuitionCol = $("<div class='col s12 m6'>").appendTo(moneyRow);
			var repaymentCol = $("<div class='col s12 m6'>").appendTo(moneyRow);

			$("<h5>").text("Tuition").appendTo(tuitionCol);
			if (school.school.tuition.pell_grant_rate > 0) {
				var perc = Math.floor(school.school.tuition.pell_grant_rate * 100);
				$("<p>").html(perc + "% of students receive Pell Grants<br><br>").appendTo(tuitionCol);
			}
			if (school.school.tuition.in_state > 0) {
				var chartID = "tuition-" + school.key;
				$("<div class='card-chart'>").attr({id: chartID}).appendTo(tuitionCol);
				// Look at http://www.pikemere.co.uk/blog/tutorial-flot-how-to-create-bar-charts/
				// for potentiall better solution
				setTimeout(function(chartID, tuition, averages) {
					var s = [
						["In State", tuition.in_state],
						["(Avg)", 0],
						["Out of State", tuition.out_state],
						["(Avg) ", 0]
					];
					var a = [
						["In State", 0],
						["(Avg)", averages["in-state-tuition"].average],
						["Out of State", 0],
						["(Avg) ", averages["out-state-tuition"].average]
					];
					$.plot("#" + chartID, [s, a], {
						series: {
							color: "green",
							bars: {show: true, align: "center"}
						},
						xaxis: {mode: "categories", tickLength: 0},
						yaxis: {axisLabel: "Tuition Cost ($)"}
					});
				}, 100, chartID, school.school.tuition, averages);
			} else {
				$("<p>").text("Tuition Data Unavailable").appendTo(tuitionCol);
			}

			$("<h5>").text("Repayment").appendTo(repaymentCol);
			if (school.school.repayment.median_debt > 0) {
				$("<p>").html("Average Student Debt: $" + school.school.repayment.median_debt + "<br><br>").appendTo(repaymentCol);
			}
			if (school.school.repayment["1_yr"] > 0) {
				var data = [
					[1, Math.floor(school.school.repayment["1_yr"] * 100)],
					[3, Math.floor(school.school.repayment["3_yr"] * 100)],
					[5, Math.floor(school.school.repayment["5_yr"] * 100)],
					[7, Math.floor(school.school.repayment["7_yr"] * 100)]
				];
				var chartID = "repayment-" + school.key;
				$("<div class='card-chart'>").attr({id: chartID}).appendTo(repaymentCol);
				setTimeout(function(chartID, repayment) {
					$.plot("#" + chartID, [{
						data: repayment,
						lines: {show: true}
					}], {
						xaxis: {min: 0},
						yaxis: {min: 50, max: 100}
					});
				}, 100, chartID, data);
			} else {
				$("<p>").text("Repayment Data Unavailable").appendTo(repaymentCol);
			}

			$("<h5>").text("Salaries").appendTo(schoolInfo);
			$("<p>").text("TODO: Add starting and eventual salaries").appendTo(schoolInfo);

			[
				minimize,
				schoolName,
				schoolLoc,
				schoolInfo
			].forEach(function(element) {
				cardContent.append(element);
			});

			return card;
		}

		$(".container").append(CardForSchool(ordered[0], averages));



		// var d1 = [];
		// var d2 = [];
		// for (var i = 0; i < 14; i ++) {
		// 	d1.push([i, Math.sin(i)]);
		// 	d1.push([i+0.5, Math.sin(i+0.5)]);
		// 	d2.push([i, Math.sin(i)]);
		// }
		//
		// $.plot("#plot", [{
		// 	data: d1,
		// 	lines: { show: true, fill: false },
		// }, {
		// 	data: d2,
		// 	bars: { show: true, width: 0.5 }
		// }])
	</script>
	</body>
</html>
